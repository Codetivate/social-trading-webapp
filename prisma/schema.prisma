generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// üè¶ BANKING GRADE SCHEMA

// --- Enums ---
enum UserRole {
  FOLLOWER
  MASTER
  ADMIN
  SUPER_ADMIN
}

enum AccountStatus {
  CONNECTED
  ERROR
  DISCONNECTED
}

enum SessionType {
  DAILY
  TRIAL_7DAY
  PAID
}

enum MasterTier {
  ROOKIE
  PRO
  TYCOON
}

enum KycStatus {
  NOT_SUBMITTED
  PENDING
  APPROVED
  REJECTED
}

enum ExecutionType {
  SELF_HOSTED // üêç Python "Hydra" Bridge (Free)
  META_API // ‚òÅÔ∏è Cloud API (Premium)
  // Future: CTRADER, FIX_PROTOCOL (CME/Institutional)
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  EARNING_FEE
  SUBSCRIPTION_PAYMENT
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  LOCKED // Escrow
  FLAGGED // AI Risk High
}

// --- Core Identity ---
model User {
  id     String   @id @default(uuid())
  email  String   @unique
  name   String?
  avatar String? // Custom Avatar
  image  String? // NextAuth standard
  role   UserRole @default(FOLLOWER)

  // üîê Security & KYC
  emailVerified DateTime?
  kycStatus     KycStatus @default(NOT_SUBMITTED)
  kycData       UserKYC? // One-to-One sensitive data separation

  // üí∞ Wallet & Finance
  walletBalance Float               @default(0)
  transactions  Transaction[]
  bankAccounts  BankAccount[]
  withdrawals   WithdrawalRequest[]

  // üìà Trading Identity
  brokerAccounts  BrokerAccount[]
  masterProfile   MasterProfile?
  followerProfile FollowerProfile?

  // üîó Social Graph
  copyingSessions CopySession[] @relation("FollowerSessions")
  followers       CopySession[] @relation("MasterSessions")

  // üõ°Ô∏è Audit
  auditLogs AuditLog[] // Actions performed by this user

  // NextAuth
  accounts Account[]
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userPromotion   UserPromotion? // üéüÔ∏è Dynamic Promotions (One-to-One)
  equitySnapshots EquitySnapshot[] // üìä Analytics History

  @@index([email])
}

// üîê NEXTAUTH MODELS
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// üîê SENSITIVE DATA (KYC)
model UserKYC {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName   String
  lastName    String
  dateOfBirth DateTime
  nationality String

  // üîí ENCRYPTED FIELDS
  idNumber     String // Encrypted
  idImageFront String? // URL to secure bucket
  idImageBack  String? // URL to secure bucket

  status          KycStatus @default(PENDING)
  reviewedBy      String? // Admin ID
  reviewedAt      DateTime?
  rejectionReason String?

  updatedAt DateTime @updatedAt
}

// üìà CONNECTED BROKERS
model BrokerAccount {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // MT5 Credentials
  login    String
  server   String
  password String // Store securely/encrypted
  mt5Path  String? // üìç Local Path to MT5 Terminal

  // State
  balance          Float         @default(0)
  equity           Float         @default(0)
  totalDeposits    Float         @default(0) // ‚úÖ Cached Total Deposits
  totalWithdrawals Float         @default(0) // ‚úÖ Cached Total Withdrawals
  leverage         Int           @default(0) // ‚úÖ Default 0 (N/A)
  currency         String        @default("USD")
  status           AccountStatus @default(CONNECTED)

  // üõ°Ô∏è RISK CONTROLS
  maxDailyLoss Float? // Max allowed loss per day (USD)
  minEquity    Float? // Hard Stop Equity Level (USD)

  // ‚ö° HYBRID EXECUTION ENGINE
  executionMethod ExecutionType @default(SELF_HOSTED)
  pid             Int? // Process ID if running on local Hydra
  port            Int? // Port number for local ZMQ/Socket

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation to Master Profile (If this account is used for broadcasting)
  masterProfiles MasterProfile[]

  // üìà OPEN POSITIONS (Real-Time Sync)
  positions      Position[]
  tradeHistories TradeHistory[]

  @@index([userId])
  @@index([login, server]) // Faster lookup for uniqueness check in app logic
}

// üé≠ PROFILES
model MasterProfile {
  id     Int    @id @default(autoincrement())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  username String?  @unique // üîó URL Handle (e.g. signaltrade.app/masternes)
  name     String
  desc     String?
  avatar   String?
  tags     String[]
  isPublic Boolean  @default(false) // ‚úÖ Private by default (Followers)

  // Metrics
  roi            Float   @default(0)
  winRate        Float   @default(0)
  drawdown       Float   @default(0)
  riskScore      Float   @default(1) // 1-5 Scale
  riskReason     String? // üìù Explanation for tooltip (e.g. "HI_VOLATILITY")
  riskReward     Float   @default(0) // ‚úÖ Added Risk Reward
  profitFactor   Float   @default(0) // ‚úÖ Added Profit Factor
  netProfit      Float   @default(0) // ‚úÖ Added Net Profit (for filtering)
  followersCount Int     @default(0)
  aum            Float   @default(0)

  // üìà Business Tier Limits
  tier           MasterTier @default(ROOKIE)
  followersLimit Int        @default(10) // Default Rookie Limit
  aumLimit       Float      @default(50000) // Default Rookie Limit
  gpShare        Float      @default(20) // 20% Profit Split

  // Plan
  monthlyFee Float @default(0)
  minDeposit Float @default(10)

  // üîó Linked Broker Account (Source of Signals)
  brokerAccountId String?
  brokerAccount   BrokerAccount? @relation(fields: [brokerAccountId], references: [id])

  createdAt DateTime @default(now())
}

model FollowerProfile {
  id     Int    @id @default(autoincrement())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  equity    Float    @default(0)
  totalPnl  Float    @default(0)
  joinedAt  DateTime @default(now())
  favorites Int[]    @default([]) // ‚úÖ Store Favorited Master IDs
}

enum ExecutionLane {
  STANDARD // üöå Batch Queue (Free)
  TURBO // üèéÔ∏è Dedicated Worker (Paid)
}

// ü§ù COPY SESSIONS (Renamed from Session)
model CopySession {
  id         Int    @id @default(autoincrement())
  followerId String
  follower   User   @relation("FollowerSessions", fields: [followerId], references: [id], onDelete: Cascade)
  masterId   String
  master     User   @relation("MasterSessions", fields: [masterId], references: [id], onDelete: Cascade)

  allocation    Float
  currentEquity Float @default(0) // ‚úÖ Shadow Equity
  riskFactor    Float // 1.0 = 100%
  unrealizedPnL Float @default(0) // ‚ö° Real-Time Floating PnL from MT5

  // Type
  type    SessionType
  isTrial Boolean     @default(false)
  expiry  DateTime? // For Trial/Golden

  // ‚ö° DISRUPTIVE ARCHITECTURE
  executionLane ExecutionLane @default(STANDARD) // Dynamic Allocation
  shardId       Int           @default(0) // For Batch Processing (0-9)

  // ‚öôÔ∏è ADVANCED SETTINGS
  autoRenew  Boolean @default(false) // ‚úÖ Default Auto-Renew
  timeConfig Json? // üïí Trading Hours { mode: "24/7" | "LONDON" | "CUSTOM", start: "09:00", end: "17:00" }

  isActive   Boolean  @default(true)
  invertCopy Boolean  @default(false) // üîÑ Invert Master Trades (Buy -> Sell)
  createdAt  DateTime @default(now())

  @@index([followerId])
  @@index([masterId])
  @@index([executionLane, shardId]) // üî• Performance Index for Hydra
}

// üìä REAL-TIME ORDER POSITIONS
model Position {
  id           Int      @id @default(autoincrement())
  ticket       BigInt   @unique // MT5 Ticket
  symbol       String
  type         String // "BUY" or "SELL"
  volume       Float
  openPrice    Float
  currentPrice Float
  sl           Float?
  tp           Float?
  swap         Float    @default(0)
  commission   Float    @default(0)
  profit       Float // Floating PnL
  openTime     DateTime // MT5 Server Time

  // Relations
  brokerAccountId String
  brokerAccount   BrokerAccount @relation(fields: [brokerAccountId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt

  @@index([brokerAccountId])
}

// üèõÔ∏è BANKING & WITHDRAWALS
model BankAccount {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  bankName      String
  accountName   String
  // üîí ENCRYPTED FIELD
  accountNumber String // Encrypted

  isVerified Boolean @default(false)
  isPrimary  Boolean @default(false)

  withdrawalRequests WithdrawalRequest[]

  createdAt DateTime @default(now())
}

model WithdrawalRequest {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccountId String
  bankAccount   BankAccount @relation(fields: [bankAccountId], references: [id])

  amount    Float
  fee       Float @default(0)
  netAmount Float

  status TransactionStatus @default(PENDING)

  // ü§ñ AI Risk Analysis
  riskScore  Int     @default(0) // 0-100
  riskReason String?

  adminNote   String?
  processedAt DateTime?

  createdAt DateTime @default(now())
}

model Transaction {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type   TransactionType
  amount Float
  status TransactionStatus @default(COMPLETED)

  // Locks
  lockedUntil DateTime? // For Escrow
  description String?

  createdAt DateTime @default(now())
}

// üõ°Ô∏è SECURITY AUDIT
model AuditLog {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  action    String // e.g. "USER_LOGIN", "WITHDRAWAL_REQUEST"
  details   String? // JSON string
  ipAddress String?

  severity  String   @default("INFO") // INFO, WARN, CRITICAL
  createdAt DateTime @default(now())
}

// üì° SIGNAL QUEUE (Execution Engine)
model Signal {
  id String @id @default(uuid())

  // Who is copying?
  followerId String

  // Who are they copying?
  masterId String

  // Trade Details
  ticket String // Master Ticket ID (64-bit)
  symbol String
  action String // OPEN, CLOSE, MODIFY
  type   String? // BUY, SELL
  volume Float?
  price  Float?
  sl     Float?
  tp     Float?

  // Execution Status
  status         String  @default("PENDING") // PENDING, EXECUTED, FAILED
  executedTicket String? // Follower Ticket ID (after execution)
  errorMessage   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([followerId, status]) // Fast lookup for polling
}

// üìä ANALYTICS & METRICS
model TradeHistory {
  id String @id @default(uuid())

  // Relationships
  followerId      String
  masterId        String
  brokerAccountId String? // ‚úÖ Linked to specific broker account
  brokerAccount   BrokerAccount? @relation(fields: [brokerAccountId], references: [id])

  // Trade Info
  symbol  String
  ticket  String // Follower Ticket
  deal    String? // MT5 Deal ID (distinct from ticket/order)
  type    String // BUY/SELL
  volume  Float
  magic   Int? // ‚úÖ Strategy ID
  comment String?

  // Price Info
  openPrice  Float
  closePrice Float
  sl         Float?
  tp         Float?

  // Time Info
  openTime  DateTime
  closeTime DateTime

  // PnL
  profit     Float // Gross Profit
  commission Float @default(0)
  swap       Float @default(0)
  fee        Float @default(0) // Platform Fee?
  netProfit  Float // Final PnL

  createdAt DateTime @default(now())

  @@index([followerId])
  @@index([masterId])
  @@index([brokerAccountId])
  @@index([closeTime])
}

model EquitySnapshot {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  balance Float
  equity  Float

  timestamp DateTime @default(now())

  @@index([userId, timestamp])
}

// üé´ USER PROMOTIOM (Tickets & VIP)
model UserPromotion {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Welcome Ticket (7-Day Trial)
  welcomeUsed      Boolean   @default(false)
  welcomeActivated DateTime?
  welcomeExpiry    DateTime?

  // Daily Ticket (4 Hours)
  dailyUsed      Boolean   @default(false)
  dailyActivated DateTime?
  dailyExpiry    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// üß† SEARCH ANALYTICS (AI & Marketing)
model SearchQuery {
  id        String   @id @default(cuid())
  term      String   @unique
  count     Int      @default(1)
  updatedAt DateTime @updatedAt

  @@index([count(sort: Desc)]) // Fast lookup for trending (Most Searched)
  @@index([updatedAt(sort: Desc)]) // Fast lookup for Recency
}
